<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Conversational H.E.A.R.T. Assessment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 40px auto;
    }
    .chat-window {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 15px;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .bubble {
      padding: 10px 14px;
      border-radius: 20px;
      max-width: 80%;
    }
    .bot { background: #f0f0f0; align-self: flex-start; }
    .user { background: #d1e7dd; align-self: flex-end; }
    .options { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .option-btn {
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      background: #e2e3e5;
      font-size: 14px;
    }
    .option-btn:hover { background: #c8d0d5; }
    #loading { display: none; margin-top: 10px; font-style: italic; }
  </style>
</head>
<body>
  <h1>Conversational H.E.A.R.T. Assessment</h1>
  <div class="chat-window" id="chatWindow">
    <!-- Chat bubbles will be injected here -->
  </div>
  <div id="loading">Calculating your H.E.A.R.T. scores‚Ä¶</div>

  <script>
    // ‚îÄ‚îÄ‚îÄ 1) The four questions & their emoji choices ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const questions = [
      {
        key: "work_feeling",
        text: "Which emoji best captures how you feel about your work right now?",
        options: [
          "üòÄ Energized",
          "üôÇ Okay",
          "üòê Meh",
          "üòì Drained",
          "üò° Frustrated"
        ]
      },
      {
        key: "team_feeling",
        text: "Which emoji best captures how you feel about your team?",
        options: [
          "ü§ù Supported",
          "üòî Alone",
          "üëÇ Heard",
          "‚ùå Dismissed",
          "üîí Safe",
          "ü§® Judged",
          "üôå Encouraged",
          "üí° Valued"
        ]
      },
      {
        key: "leadership_feeling",
        text: "Which emoji best captures how you feel about leadership?",
        options: [
          "üîä Clear",
          "üôÅ Distant",
          "üéØ Trustworthy",
          "‚òÅÔ∏è Unclear",
          "‚ú® Inspiring",
          "ü§® Rigid",
          "üòì Micromanaging",
          "üîí Safe"
        ]
      },
      {
        key: "company_people_feeling",
        text: "Which emoji best captures how you feel about people at your company?",
        options: [
          "ü§ó Included",
          "üòí Ignored",
          "‚ù§Ô∏è Connected",
          "ü§ù Respectful",
          "ü§î Suspicious",
          "üö™ Excluded",
          "üîí Safe",
          "üòì Isolated"
        ]
      }
    ];

    // We‚Äôll store each answer here:
    const answers = {};

    // Index of the question we are currently on:
    let currentQuestionIndex = 0;

    const chatWindow = document.getElementById("chatWindow");
    const loadingIndicator = document.getElementById("loading");

    // ‚îÄ‚îÄ‚îÄ Utility: Add a ‚Äúbot‚Äù bubble with some text ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addBotBubble(text) {
      const bubble = document.createElement("div");
      bubble.className = "bubble bot";
      bubble.innerText = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ‚îÄ‚îÄ‚îÄ Utility: Add a ‚Äúuser‚Äù bubble with the chosen answer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addUserBubble(text) {
      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      bubble.innerText = text;
      chatWindow.appendChild(bubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ‚îÄ‚îÄ‚îÄ Utility: Render the emoji‚Äêoptions buttons for the current question ‚îÄ
    function renderOptions(options, questionKey) {
      const container = document.createElement("div");
      container.className = "options";

      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "option-btn";
        btn.innerText = opt;
        btn.onclick = () => handleUserChoice(questionKey, opt);
        container.appendChild(btn);
      });

      chatWindow.appendChild(container);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ‚îÄ‚îÄ‚îÄ Handler when user picks one option ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function handleUserChoice(questionKey, chosenText) {
      // 1) Remove all existing option buttons (so user can‚Äôt click again)
      document.querySelectorAll(".options").forEach(el => el.remove());

      // 2) Show the user‚Äôs choice as a user‚Äêbubble
      addUserBubble(chosenText);

      // 3) Store it
      answers[questionKey] = chosenText;

      // 4) Move to the next question after a short delay:
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        setTimeout(renderNextQuestion, 400);
      } else {
        // All four answered; now call the backend for H.E.A.R.T. scoring
        setTimeout(callScoringAPI, 400);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Show the next question (bot bubble + options) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderNextQuestion() {
      const q = questions[currentQuestionIndex];
      addBotBubble(q.text);
      renderOptions(q.options, q.key);
    }

    // ‚îÄ‚îÄ‚îÄ Once all four are answered, send them to /score and show the result ‚îÄ
    async function callScoringAPI() {
      // Show ‚Äúloading‚Ä¶‚Äù line
      loadingIndicator.style.display = "block";

      try {
        const resp = await fetch("/score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(answers)
        });
        const data = await resp.json();
        loadingIndicator.style.display = "none";

        if (resp.ok && data.heart_scores) {
          addBotBubble("üìä Here are your H.E.A.R.T. scores:");
          // Show the raw GPT reply inside a <pre> block
          const pre = document.createElement("pre");
          pre.style.background = "#f8f9fa";
          pre.style.padding = "12px";
          pre.style.borderRadius = "4px";
          pre.style.whiteSpace = "pre-wrap";
          pre.innerText = data.heart_scores;
          chatWindow.appendChild(pre);
        } else {
          addBotBubble("‚ö†Ô∏è Sorry, something went wrong. Please try again later.");
        }
      } catch (err) {
        loadingIndicator.style.display = "none";
        addBotBubble("‚ö†Ô∏è Network or server error. Please refresh and try again.");
        console.error(err);
      }
    }

    // ‚îÄ‚îÄ‚îÄ Kick things off by rendering question #1 after page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.addEventListener("DOMContentLoaded", () => {
      renderNextQuestion();
    });
  </script>
</body>
</html>
